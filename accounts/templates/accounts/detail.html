{% extends 'base.html' %}

{% block content %}
  <br>
  <h2>{{ auth_user.username }}</h2>
  <hr>
  {% for review in ratings %}
    <a href="{% url 'movies:detail' review.movie.pk %}"><h4>{{ review.movie.title }}</h4></a>
    
    {{ review.score }} | {{ review.comment }}
    <hr>
  {% endfor %}

  {% with followers=auth_user.follow_user.all followings=auth_user.following_user.all %}
    <h5>
    팔로워: <span id="follow-count-{{auth_user.pk}}">{{ auth_user.follow_user.count }}</span>
    팔로잉: {{ followings|length }}
    </h5>
    <select name="" id="">
      {% for following in followers %}
        <a href="{% url 'accounts:user_detail' following.pk %}"><option value="following.username">{{following.username}}</option></a>
      {% endfor %}
    </select>
    
    <hr>
    {% if user.is_authenticated %}
      {% if user != auth_user %}
        {% if user in follwers %}
          <span class="btn btn-danger follow" data-id="{{ auth_user.pk }}">UnFollow</span>
        {% else %}
          <span class="btn btn-danger follow" data-id="{{ auth_user.pk }}">Follow</span>

        {% endif %}
      {% endif %}
    {% endif %}
  {% endwith %}
  <a href="{% url 'accounts:index' %}" class="btn btn-info">BACK</a>
{% endblock content %}
{% block script %}
<script>
const follows = document.querySelectorAll('.follow')
follows.forEach(button => {
  button.addEventListener('click', function(event) {
    const followId = event.target.dataset.id
    axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
    axios.defaults.xsrfCookieName = 'csrftoken'
    axios.defaults.xsrfHeaderName = 'X-CSRFToken'
    axios.get(`/accounts/follow/${followId}/`)
      .then(response => {
        document.querySelector(`#follow-count-${followId}`).innerText = response.data.count
        if (response.data.followed) {
          
          event.target.innerText = "Follow"
        } else {
          
          event.target.innerText = "Unfollow"
        }
      })
      .catch(error => console.log(error))
  })
})

</script>
{% endblock script %}